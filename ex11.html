<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-2.4.2.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@holoviz/panel@0.13.1/dist/panel.min.js"></script>
    <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
    <py-env>
      - bokeh
      - panel==0.13.1
      - scikit-learn
      - matplotlib
      - pandas
      - numpy
    </py-env>
    <title>Clustering</title>
  </head>
  <body>
    <py-box>
      <py-title>Clustering</py-title>
    </py-box>
    <py-box>
      <div id="data_selector"></div>
      <div id="algo_selector"></div>
    </py-box>
    <py-box>
      <div id="slider"></div>
    </py-box>
    <py-box>
      <div id="plt"></div>
    </py-box>
    <py-script>

      import panel as pn
      from sklearn.datasets import make_blobs
      from sklearn.datasets import make_circles
      from sklearn.cluster import KMeans
      from sklearn.cluster import MeanShift
      from sklearn.mixture import GaussianMixture
      from sklearn.cluster import DBSCAN
      import matplotlib.pyplot as plt
      import pandas as pd
      import numpy as np


      clustering_algorithms = ["K-Means", "Mean Shift", "GMM", "DBSCAN"]
      datasets = ["Blob", "Circle"]

      slider = pn.widgets.IntSlider(
        start=1, end=7, step=1, name="Number of Cluster"
      ).servable(target="slider")
      algo_selector = pn.widgets.Select(
        name="Algorithm", options=clustering_algorithms, value="Select algorithm"
      ).servable(target="algo_selector")
      data_selector = pn.widgets.Select(
        name="Data", options=datasets, value="Select Data"
      ).servable(target="data_selector")


      def prepare_data(data):

        if data == "Blob":
          X, y = make_blobs(n_samples=300, n_features=2, centers=3, 
                            cluster_std=0.6, random_state=0)
          df = pd.DataFrame(data=X, columns=["ftr1", "ftr2"])
          df["target"] = y

        else:
          X, y = make_circles(n_samples=500, shuffle=True, noise=0.05, random_state=0, factor=0.5)
          df = pd.DataFrame(data=X, columns=['ftr1', 'ftr2'])
          df['target'] = y

        return X, df


      def draw_plot(df, cluster_labels, centers=None):
        fig, ax = plt.subplots()
        df['cluster_labels'] = cluster_labels
        unique_labels = np.unique(cluster_labels)
        markers = ['o', 's', '^', 'P', 'D', 'H', 'x']

        for label in unique_labels:
          label_cluster = df[df['cluster_labels'] == label]          
          ax.scatter(x=label_cluster['ftr1'], y=label_cluster['ftr2'], 
                     edgecolors='k', marker=markers[label])
          
          if centers is not None:
            center_x_y = centers[label]
            ax.scatter(x=center_x_y[0], y=center_x_y[1], s=200, color='white', 
                       alpha=0.9, edgecolors='k', marker=markers[label])
            number = label + 1
            ax.scatter(x=center_x_y[0], y=center_x_y[1], s=70, color='k', 
                       edgecolors='k', marker='$%d$' % number)

        return fig

     
      def get_plot(X, df, algorithm, n_clusters):

        if algorithm == "K-Means":
          kmeans = KMeans(n_clusters=n_clusters)
          cluster_labels = kmeans.fit_predict(X)          
          centers = kmeans.cluster_centers_
          return draw_plot(df, cluster_labels, centers)

        elif algorithm == "Mean Shift":
          meanshift = MeanShift(bandwidth=1)
          cluster_labels = meanshift.fit_predict(X)
          centers = meanshift.cluster_centers_
          return draw_plot(df, cluster_labels, centers)

        elif algorithm == "GMM":
          gmm = GaussianMixture(n_components=n_clusters, random_state=3)
          cluster_labels = gmm.fit_predict(X)
          return draw_plot(df, cluster_labels)

        else:
          dbscan = DBSCAN(eps=0.2, min_samples=8, metric='euclidean')
          cluster_labels = dbscan.fit_predict(X)
          return draw_plot(df, cluster_labels)     
        

      plot = pn.pane.Matplotlib().servable(target="plt")


      @pn.depends(algo_selector, data_selector, slider, watch=True)
      def update_plot(*event):
        X, df = prepare_data(data_selector.value)
        plot.object = get_plot(X, df, algo_selector.value, slider.value)      


      update_plot()

    </py-script>
  </body>
</html>